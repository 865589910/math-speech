#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ•°å­¦å­¦ä¹ å·¥å…· - AIè¯­éŸ³æ‰¹é‡ç”Ÿæˆè„šæœ¬
ä½¿ç”¨ Edge TTS ä¸ºæ‰€æœ‰å­—è¯ç”Ÿæˆé«˜è´¨é‡AIè¯­éŸ³éŸ³é¢‘æ–‡ä»¶
"""

import asyncio
import edge_tts
import os
from pathlib import Path

# é…ç½®
VOICE = "zh-CN-XiaoxiaoNeural"  # ä½¿ç”¨æ™“æ™“çš„å£°éŸ³ï¼ˆå¥³å£°ï¼Œæ¸©æŸ”è‡ªç„¶ï¼Œé€‚åˆå°æœ‹å‹ï¼‰
OUTPUT_DIR = "audio"  # éŸ³é¢‘æ–‡ä»¶è¾“å‡ºç›®å½•
RATE = "-4%"  # è¯­é€Ÿï¼šç¨æ…¢ä¸€ç‚¹ï¼Œé€‚åˆå­¦ä¹ 
VOLUME = "+0%"  # éŸ³é‡ï¼šæ­£å¸¸

# å¤šéŸ³å­—æ­£ç¡®è¯»éŸ³æ˜ å°„ï¼ˆä½¿ç”¨åŒéŸ³å­—æˆ–æ•°å­—æ ‡è°ƒæ‹¼éŸ³ï¼‰
POLYPHONE_MAP = {
    'è¡Œ': 'èˆª',  # è¡Œåˆ—çš„è¡Œï¼Œç”¨åŒéŸ³å­—"èˆª"æ¥ç”Ÿæˆæ­£ç¡®è¯»éŸ³
}

# æ‰€æœ‰éœ€è¦ç”Ÿæˆçš„å­—è¯æ•°æ®
learning_data = {
    "section1_numbers": [
        "é›¶", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å",
        "ä¸ª", "ç™¾", "åƒ", "ä¸‡"
    ],
    "section1_operations": [
        "åŠ ", "å‡", "ä¹˜", "é™¤", "å·®", "å’Œ", "ç§¯", "å•†",
        "åŠ å·", "å‡å·", "ä¹˜å·", "é™¤å·",
        "åŠ æ•°", "è¢«å‡æ•°", "å‡æ•°", "ä¹˜æ•°", "è¢«é™¤æ•°", "é™¤æ•°",
        "ç­‰å·", "å¤§äºå·", "å°äºå·", "ç®—å¼", "è®¡ç®—"
    ],
    "section1_positions": [
        "è¡Œ", "åˆ—", "æ’", "ä¸Š", "ä¸‹", "å·¦", "å³", "å‰", "å",
        "ä¸œ", "è¥¿", "å—", "åŒ—", "é‡Œ", "å†…", "å¤–"
    ],
    "section1_comparisons": [
        "å¤§", "å°", "å¤š", "å°‘", "é•¿", "çŸ­", "é«˜", "çŸ®",
        "è½»", "é‡", "åš", "è–„", "å¿«", "æ…¢"
    ],
    "section1_units": [
        "å˜ç±³", "ç±³", "å…ƒ", "è§’", "åˆ†", "æ—¶", "ç§’", "å…‹", "åƒå…‹"
    ],
    "section1_quantifiers": [
        "ä¸ª", "ä½", "å", "äºº", "åª", "è¾†", "å—", "ç“¶", "æ”¯", "æœ¬",
        "é¢—", "å¼ ", "æŠŠ", "æ£µ", "ç›’", "ç®±", "ç›˜", "å †", "ç²’", "ä¸²",
        "æ¶", "è‰˜", "æ‹ƒ", "æ­¥", "åº¹", "å€"
    ],
    "section2_questionTypes": [
        "å¡«ä¸€å¡«", "ç®—ä¸€ç®—", "å†™ä¸€å†™", "ç”»ä¸€ç”»", "è¯»ä¸€è¯»", "é€‰ä¸€é€‰",
        "åšä¸€åš", "åˆ†ä¸€åˆ†", "åœˆä¸€åœˆ", "æ‘†ä¸€æ‘†", "æ‹¨ä¸€æ‹¨", "æ¶‚é¢œè‰²",
        "æ‰¾è§„å¾‹", "åˆ—ç«–å¼", "å£ç®—", "è§£å†³é—®é¢˜", "åˆ—å¼è®¡ç®—",
        "æ‰¾ä¿¡æ¯", "æé—®é¢˜", "çœ‹å›¾åˆ—å¼"
    ],
    "section2_basicConcepts": [
        "å¤§äº", "å°äº", "ç­‰äº", "ä¸€å…±", "è¿˜æœ‰", "å‰©ä¸‹", "å‡ ä¸ª", "ç¬¬å‡ ",
        "æ•°æ•°", "é¡ºç€æ•°", "å€’ç€æ•°", "ä»å·¦å¾€å³", "ä»ä¸Šå¾€ä¸‹", "ç›¸é‚»æ•°",
        "ç»„æˆ", "æ•°ä½", "ä½æ•°", "å†™æ•°", "è¯»æ•°", "å•æ•°", "åŒæ•°", "å¥‡æ•°",
        "å¶æ•°", "è§„å¾‹", "æ•´æ—¶", "å¤§å°", "å¤šå°‘", "é•¿çŸ­", "å¹³å‡åˆ†",
        "ä¹˜æ³•å£è¯€", "æœ€å¤§", "æœ€å°", "è¿åŠ ", "è¿å‡", "æ··åˆè¿ç®—",
        "åˆ†ä¸åˆ", "å‡‘åæ³•", "ç ´åæ³•", "å¹³åæ³•", "ç”»å›¾æ³•", "çº¿æ®µ",
        "é•¿åº¦", "é‡é‡", "æµ‹é‡", "çŒœæµ‹", "ä¼°è®¡", "åˆé€‚", "å¯¹åŠ",
        "è´­ç‰©", "ä»˜ç»™", "æ‰¾å›", "å”®å‡º", "è´­ä¹°"
    ],
    "section2_items": [
        "ç§¯æœ¨", "æ‹¼å›¾", "ç©å…·æ±½è½¦", "ç©å…·é£æœº", "æ°”çƒ",
        "é£ç­", "æ¯½å­", "å¦å…‹", "ç«è½¦", "èˆ¹"
    ],
    "section2_animals": [
        "å°é¸¡", "å°é¸­", "å…”å­", "å°çŒ«", "å°ç‹—",
        "å°é¸Ÿ", "é’è›™", "çŒ´å­", "ä¼é¹…", "å°é±¼"
    ],
    "section2_foods": [
        "è‹¹æœ", "é¦™è•‰", "æ¡ƒå­", "æ©˜å­", "è‰è“", "è¥¿ç“œ", "è‘¡è„",
        "ç³–æœ", "è›‹ç³•", "é¢åŒ…", "ç‰›å¥¶", "è–¯ç‰‡", "å·§å…‹åŠ›"
    ],
    "section2_shapes": [
        "é•¿æ–¹å½¢", "æ­£æ–¹å½¢", "åœ†", "ä¸‰è§’å½¢", "å¹³è¡Œå››è¾¹å½¢",
        "é•¿æ–¹ä½“", "æ­£æ–¹ä½“", "åœ†æŸ±", "çƒ", "ä¸‰æ£±æŸ±"
    ],
    "section3_fillMethods": [
        "åŠ æ•°åŠ åŠ æ•°ç­‰äºå’Œ",
        "å’Œå‡åŠ æ•°ç­‰äºåŠ æ•°",
        "è¢«å‡æ•°å‡å‡æ•°ç­‰äºå·®",
        "è¢«å‡æ•°å‡å·®ç­‰äºå‡æ•°",
        "å‡æ•°åŠ å·®ç­‰äºè¢«å‡æ•°",
        "ä¹˜æ•°ä¹˜ä¹˜æ•°ç­‰äºç§¯",
        "ç§¯é™¤ä¹˜æ•°ç­‰äºä¹˜æ•°",
        "è¢«é™¤æ•°é™¤é™¤æ•°ç­‰äºå•†",
        "è¢«é™¤æ•°é™¤å•†ç­‰äºé™¤æ•°",
        "é™¤æ•°ä¹˜å•†ç­‰äºè¢«é™¤æ•°"
    ],
    "section3_comparisonRules": [
        "åŠ æ•°å˜å¤§å’Œå˜å¤§",
        "åŠ æ•°å˜å°å’Œå˜å°",
        "åŠ æ•°ä¸€å¢ä¸€å‡å’Œä¸å˜",
        "è¢«å‡æ•°å˜å¤§å·®å˜å¤§",
        "å‡æ•°å˜å¤§å·®å˜å°",
        "è¢«å‡æ•°å‡æ•°åŒå¢å‡å·®ä¸å˜",
        "ä¹˜æ•°å˜å¤§ç§¯å˜å¤§",
        "ä¹˜æ•°å˜å°ç§¯å˜å°"
    ],
    "section3_hundredTable": [
        "å¾€ä¸Šå‡10",
        "å¾€ä¸‹åŠ 10",
        "å¾€å·¦å‡1",
        "å¾€å³åŠ 1"
    ],
    "section4_additionProblems": [
        "ä¸€å…±",
        "æ€»å…±",
        "å…±æœ‰",
        "ä¸€å…±æˆ–æ€»å…±æˆ–å…±æœ‰",
        "å’Œ",
        "å¢åŠ ",
        "æ·»ä¸Š",
        "å¢åŠ æˆ–æ·»ä¸Š",
        "åˆèµ·æ¥",
        "å€’å…¥",
        "é£æ¥äº†",
        "æ¸¸æ¥äº†",
        "å¼€æ¥äº†"
    ],
    "section4_subtractionProblems": [
        "è¿˜å‰©",
        "å‰©ä¸‹",
        "è¿˜å‰©æˆ–å‰©ä¸‹",
        "æ¯”å¤š",
        "æ¯”å°‘",
        "æ¯”å¤šæˆ–æ¯”å°‘",
        "å¤šå¤šå°‘",
        "å°‘å¤šå°‘",
        "å¤šå¤šå°‘æˆ–å°‘å¤šå°‘",
        "èŠ±äº†",
        "ç”¨å»",
        "å‡å°‘",
        "å‡å°‘æˆ–ç”¨å»",
        "é€ç»™",
        "é£èµ°äº†",
        "æ¸¸èµ°äº†",
        "é£èµ°æˆ–æ¸¸èµ°",
        "ç›¸å·®"
    ],
    "section4_multiplicationProblems": [
        "æ¯â€¦â€¦æœ‰â€¦â€¦",
        "æ¯",
        "æ¯â€¦â€¦æœ‰â€¦â€¦æˆ–æ¯",
        "å€",
        "ç§¯",
        "å‡ ä¸ªå‡ ",
        "ä¸€å…±"
    ],
    "section4_divisionProblems": [
        "å¹³å‡åˆ†",
        "æ¯å‡ ä¸ªè£…ä¸€",
        "å•†",
        "å¹³å‡æ¯ä¸ªæ˜¯å‡ ",
        "èƒ½åˆ†å‡ ä»½"
    ]
}


def sanitize_filename(word):
    """å°†å­—è¯è½¬æ¢ä¸ºå®‰å…¨çš„æ–‡ä»¶å"""
    # ç‰¹æ®Šå­—ç¬¦æ›¿æ¢
    replacements = {
        'ï¼‹': 'åŠ å·', 'ï¼': 'å‡å·', 'Ã—': 'ä¹˜å·', 'Ã·': 'é™¤å·',
        '=': 'ç­‰å·', '>': 'å¤§äºå·', '<': 'å°äºå·',
        '/': '_', '\\': '_', ':': '_', '*': '_',
        '?': '_', '"': '_', '|': '_'
    }
    
    filename = word
    for char, replacement in replacements.items():
        filename = filename.replace(char, replacement)
    
    return filename


async def generate_audio(word, category=""):
    """ä¸ºå•ä¸ªå­—è¯ç”ŸæˆéŸ³é¢‘æ–‡ä»¶"""
    try:
        # åˆ›å»ºå®‰å…¨çš„æ–‡ä»¶å
        safe_filename = sanitize_filename(word)
        filename = f"{safe_filename}.mp3"
        
        # åˆ›å»ºç›®å½•ç»“æ„
        if category:
            output_path = os.path.join(OUTPUT_DIR, category)
        else:
            output_path = OUTPUT_DIR
        
        os.makedirs(output_path, exist_ok=True)
        filepath = os.path.join(output_path, filename)
        
        # å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡
        if os.path.exists(filepath):
            print(f"  â­ï¸  è·³è¿‡ {word} (å·²å­˜åœ¨)")
            return True
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šéŸ³å­—ï¼Œå¦‚æœæ˜¯ï¼Œä½¿ç”¨æ‹¼éŸ³ä»£æ›¿
        if word in POLYPHONE_MAP:
            # å¯¹äºå¤šéŸ³å­—ï¼Œç›´æ¥ä½¿ç”¨æ‹¼éŸ³ç”Ÿæˆè¯­éŸ³
            text_to_speak = POLYPHONE_MAP[word]
            print(f"  ğŸ”Š å¤šéŸ³å­—ä¿®æ­£: {word} -> ä½¿ç”¨æ‹¼éŸ³ {text_to_speak}")
            communicate = edge_tts.Communicate(text_to_speak, VOICE, rate=RATE, volume=VOLUME)
        else:
            # æ™®é€šå­—è¯
            text_to_speak = word
            communicate = edge_tts.Communicate(word, VOICE, rate=RATE, volume=VOLUME)
        
        await communicate.save(filepath)
        
        print(f"  âœ… ç”Ÿæˆ {word} -> {filepath}")
        return True
        
    except Exception as e:
        print(f"  âŒ å¤±è´¥ {word}: {str(e)}")
        return False


async def generate_all_audio():
    """æ‰¹é‡ç”Ÿæˆæ‰€æœ‰å­—è¯çš„éŸ³é¢‘"""
    print("=" * 60)
    print("ğŸ™ï¸  å¼€å§‹æ‰¹é‡ç”ŸæˆAIè¯­éŸ³...")
    print(f"ğŸ“ è¾“å‡ºç›®å½•: {OUTPUT_DIR}/")
    print(f"ğŸ¤ ä½¿ç”¨éŸ³è‰²: {VOICE} (æ™“æ™“-æ¸©æŸ”å¥³å£°)")
    print(f"âš¡ è¯­é€Ÿ: {RATE}")
    print("=" * 60)
    
    total = 0
    success = 0
    
    # éå†æ‰€æœ‰åˆ†ç±»
    for category_name, words_list in learning_data.items():
        print(f"\nğŸ“š å¤„ç† {category_name} ({len(words_list)} ä¸ª)")
        
        # ç”Ÿæˆæ¯ä¸ªå­—è¯çš„éŸ³é¢‘
        for word in words_list:
            total += 1
            result = await generate_audio(word, category_name)
            if result:
                success += 1
            
            # æ¯ç”Ÿæˆ5ä¸ªéŸ³é¢‘ç¨å¾®æš‚åœä¸€ä¸‹
            if total % 5 == 0:
                await asyncio.sleep(0.3)
    
    print("\n" + "=" * 60)
    print(f"ğŸ‰ ç”Ÿæˆå®Œæˆï¼")
    print(f"ğŸ“Š æ€»è®¡: {total} ä¸ª | æˆåŠŸ: {success} ä¸ª | å¤±è´¥: {total - success} ä¸ª")
    print(f"ğŸ“ éŸ³é¢‘æ–‡ä»¶ä¿å­˜åœ¨: {os.path.abspath(OUTPUT_DIR)}")
    print("=" * 60)


async def main():
    """ä¸»å‡½æ•°"""
    await generate_all_audio()


if __name__ == "__main__":
    print("\n" + "ğŸ¼" * 20)
    print("   æ•°å­¦å­¦ä¹ å·¥å…· - AIè¯­éŸ³æ‰¹é‡ç”Ÿæˆ")
    print("ğŸ¼" * 20 + "\n")
    
    # è¿è¡Œå¼‚æ­¥ä»»åŠ¡
    asyncio.run(main())
    
    print("\nâœ¨ å…¨éƒ¨å®Œæˆï¼ç°åœ¨å¯ä»¥åœ¨ç½‘ç«™ä¸­ä½¿ç”¨è¿™äº›é«˜è´¨é‡AIè¯­éŸ³äº†ï¼\n")
